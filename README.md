# License Management System API (SQLite & Prisma)

This project is a Node.js-based API for managing software licenses, subscriptions, and users. It uses SQLite as its database and Prisma as its ORM.

## Features

*   User registration and authentication (JWT-based)
*   Core license management (create, read, update, delete, validate)
*   Subscription management
*   Role-based access control (CLIENT, ADMIN)
*   Database interactions managed via Prisma ORM with SQLite.

## Project Structure

*   `prisma/`: Prisma schema, migrations, and SQLite database file
    *   `schema.prisma`: Defines database models and relations.
    *   `dev.db`: SQLite database file (created after first migration).
    *   `migrations/`: Directory containing SQL migration files generated by Prisma.
*   `src/`: Main application source code
    *   `config/`: Configuration files (e.g., environment variables load).
    *   `controllers/`: Business logic for API endpoints.
    *   `generated/prisma/`: Prisma Client generated based on your schema.
    *   `lib/`: Shared library code, including `prisma.js` for Prisma Client instance.
    *   `middleware/`: Express middleware (e.g., authentication).
    *   `models/`: Contains `index.js` which re-exports the Prisma client. (Legacy from previous structure, could be merged into `lib`).
    *   `routes/`: API route definitions.
    *   `tests/`: Unit and integration tests.
    *   `server.js`: Main application entry point.
*   `.env`: Environment variable configuration.
*   `.gitignore`: Specifies intentionally untracked files.
*   `package.json`: Project metadata and dependencies.

## Prerequisites

*   [Node.js](https://nodejs.org/) (version 14.x or later recommended)
*   [npm](https://www.npmjs.com/) (usually comes with Node.js)

## Setup and Installation

1.  **Clone the repository:**
    ```bash
    git clone <repository-url>
    cd <repository-directory>
    ```

2.  **Install dependencies:**
    ```bash
    npm install
    ```

3.  **Set up environment variables:**
    The `.env` file should have been created by `npx prisma init` or be present. Ensure it has the following (Prisma init typically sets DATABASE_URL):
    ```env
    DATABASE_URL="file:./prisma/dev.db" # Or just "file:dev.db" if db is in root
    NODE_ENV=development
    PORT=3000
    JWT_SECRET=yourjwtsecretfallback # Change this to a strong, unique secret
    ```
    *Note: Prisma will create the `dev.db` file in the `prisma` directory by default if `DATABASE_URL="file:./dev.db"` is used. If you used `DATABASE_URL="file:dev.db"`, it will be in the project root.*

4.  **Run Database Migrations:**
    This command will create the SQLite database file (`prisma/dev.db`) based on your `DATABASE_URL`, apply existing migrations, and generate/update Prisma Client.
    ```bash
    npx prisma migrate dev
    ```
    If you are setting up for the first time and migrations exist, this will apply them. If you modify `schema.prisma`, you'll run `npx prisma migrate dev --name your-migration-name` to create a new migration.

## Running the Application

```bash
npm star` + `t
```
This will typically start the server on `http://localhost:3000` (or the port specified in your `.env` file).

## Running Tests

```bash
npm test
```
This command will execute the Jest unit tests. The tests are configured to run against the SQLite database defined in your `.env` file and include cleanup routines.

## Basic API Endpoints Overview

All endpoints are prefixed with `/api`. Ensure you send the `x-auth-token` header with a valid JWT for protected routes.

### Authentication (`/auth`)

*   `POST /auth/register`: Register a new user.
    *   Body: `{ "email": "user@example.com", "password": "yourpassword", "role": "CLIENT" (optional, defaults to CLIENT) }`
*   `POST /auth/login`: Login an existing user.
    *   Body: `{ "email": "user@example.com", "password": "yourpassword" }`
    *   Returns: JWT token.

### Licenses (`/licenses`) - Requires `x-auth-token`

*   `POST /licenses`: Create a new license.
    *   Body: `{ "userId": 1 (optional, defaults to self if not admin), "status": "ACTIVE" (optional), "expiresAt": "YYYY-MM-DDTHH:mm:ss.sssZ" (optional), "productId": 1 (optional) }`
*   `GET /licenses`: List licenses (all for admin, own for client).
*   `GET /licenses/:id`: Get a specific license.
*   `PUT /licenses/:id`: Update a license (admin only).
*   `DELETE /licenses/:id`: Delete a license (admin only).
*   `POST /licenses/validate`: Validate a license key.
    *   Body: `{ "licenseKey": "uuid-license-key" }`

### Subscriptions (`/subscriptions` & `/users`) - Requires `x-auth-token`

*   `POST /subscriptions`: Create a new subscription.
*   `GET /subscriptions/mine`: Get logged-in user's subscriptions.
*   `GET /subscriptions`: Get all subscriptions (admin only, non-admin gets their own).
*   `GET /users/:userId/subscriptions`: Get subscriptions for a specific user (admin or self).
*   `PUT /subscriptions/:subscriptionId`: Update a subscription (admin or owner).

### Payments (`/payments`)

*   `POST /payments/initiate`: Placeholder for initiating a payment (requires auth).
*   `POST /payments/webhook`: Placeholder for receiving payment provider webhooks.

---

This README provides an overview of the refactored application using SQLite and Prisma.
